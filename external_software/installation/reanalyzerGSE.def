# This is a definition file for an Apptainer container with the reanalyzerGSE pipeline and their dependencies properly installed
# This is not using multiple conda environments as the preferred second option, but trying to download/installe/compile all of the require binaries


Bootstrap: docker
From: ubuntu:latest

%post
  # Install dependencies and software:
  export DEBIAN_FRONTEND=noninteractive && apt-get update -qq > /dev/null && \
    apt-get install -qy --no-install-recommends apt-utils wget software-properties-common dirmngr pkg-config locales > /dev/null

    locale-gen en_US.UTF-8
    update-locale LANG=en_US.UTF-8
    echo "export LANG=en_US.UTF-8" >> ~/.bashrc
    echo "export LC_ALL=en_US.UTF-8" >> ~/.bashrc

    wget -qO- https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc | tee -a /etc/apt/trusted.gpg.d/cran_ubuntu_key.asc && \
    add-apt-repository "deb https://cloud.r-project.org/bin/linux/ubuntu $(lsb_release -cs)-cran40/" > /dev/null && \
    apt-get install -qy --no-install-recommends fastqc pigz curl parallel zip make cmake bc bzip2 expat file cython3 git-all \
      software-properties-common libfreetype6-dev libtiff5-dev libjpeg-dev libxml2 libxml2-dev zlib1g-dev build-essential gcc g++ libcairo2-dev libncurses5-dev liblzma-dev libssl-dev libharfbuzz-dev libfribidi-dev libtbb12 \
      locales libmagick++-dev libmagickwand-dev libmagickcore-dev imagemagick libpng-dev libpng-tools libpng16-16 libssl-dev libconfig-ini-perl libtemplate-plugin-posix-perl libscalar-list-utils-perl libwww-perl libdatetime-perl libstatistics-r-perl libconfig-inifiles-perl \
      cpanminus \
      r-base r-base-dev pandoc \
      python-is-python3 python-dev-is-python3 python3-dev python3-pip python3-deeptools > /dev/null && apt-get -qy autoremove --purge > /dev/null && apt-get -q clean && rm -rf /var/lib/apt/lists/*


    export DEBIAN_FRONTEND=noninteractive && apt-get update -qq > /dev/null && apt-get install --reinstall -yq --no-install-recommends libc6-dev linux-libc-dev libcurl4-openssl-dev libsqlite3-dev libopenblas-dev > /dev/null
    curl -fsSL https://pyenv.run | bash > /dev/null
        
    git clone -q https://github.com/BioinfoIPBLN/reanalyzerGSE && chmod +x /reanalyzerGSE/reanalyzerGSE.sh && chmod +x /reanalyzerGSE/scripts/* && chmod +x /reanalyzerGSE/external_software/miARma-seq/miARma && rm -rf /reanalyzerGSE/test_data
    
    mkdir -p bin_external/lib
    wget -q https://ftp-trace.ncbi.nlm.nih.gov/sra/sdk/current/sratoolkit.current-ubuntu64.tar.gz && tar xzf sratoolkit.current-ubuntu64.tar.gz && mv sratoolkit*/bin/* bin_external/ && rm -rf sratoolkit*
    wget -q https://github.com/samtools/samtools/releases/download/1.22/samtools-1.22.tar.bz2 && tar xf samtools-*.tar.bz2 && cd samtools-* && mkdir bin && ./configure -q --prefix=$PWD/bin && make -s && make -s install && cd .. && mv samtools*/bin/bin/* bin_external/ && rm -rf samtools*
    yes n | sh -c "$(wget -q https://ftp.ncbi.nlm.nih.gov/entrez/entrezdirect/install-edirect.sh -O -)"    
    wget -q http://opengene.org/fastp/fastp && chmod a+x ./fastp && mv fastp bin_external
    wget -q https://github.com/shenwei356/taxonkit/releases/download/v0.20.0/taxonkit_linux_amd64.tar.gz && tar xzf taxonkit_linux_amd64.tar.gz && rm taxonkit_linux_amd64.tar.gz && mv taxonkit bin_external/
    wget -q https://github.com/sortmerna/sortmerna/releases/download/v4.3.7/sortmerna-4.3.7-Linux.tar.gz && tar xzf sortmerna-*-Linux.tar.gz && mv sortmerna*/bin/* bin_external/ && rm -rf sortmerna*    
    wget -q https://github.com/COMBINE-lab/salmon/releases/download/v1.10.0/salmon-1.10.0_linux_x86_64.tar.gz && tar xzf salmon-1.10.0_linux_x86_64.tar.gz && mv salmon*/bin/* bin_external/ && rm -rf salmon*
    wget -q https://github.com/pachterlab/kallisto/releases/download/v0.51.1/kallisto_linux-v0.51.1.tar.gz && tar xzf kallisto_linux-*.tar.gz && mv kallisto/kallisto bin_external/ && rm -rf kallisto*
    wget -q https://github.com/alexdobin/STAR/releases/download/2.7.11b/STAR_2.7.11b.zip && unzip -qq STAR_2.7.11b.zip && mv STAR*/Linux_x86_64_static/* bin_external/ && rm -rf STAR*
    wget -q https://cloud.biohpc.swmed.edu/index.php/s/oTtGWbWjaxsQ2Ho/download && unzip -qq download && rm download && mv hisat*/hisat* bin_external/ && rm -rf hisat*
    wget -q https://sourceforge.net/projects/subread/files/subread-2.1.1/subread-2.1.1-Linux-x86_64.tar.gz/download && tar -xzf download && rm download && mv subread*/bin/* bin_external/ && rm -rf subread*
    wget -q https://bitbucket.org/kokonech/qualimap/downloads/qualimap_v2.3.zip && unzip -qq qualimap_v2.3.zip && sed -i 's/-XX:MaxPermSize/-XX:MaxMetaspaceSize/g' /qualimap_v2.3/qualimap && mv qualimap*/qualimap bin_external/ && mv qualimap*/qualimap.jar bin_external/ && mv qualimap*/lib/* bin_external/lib/ && rm -rf qualimap*
    
    git clone -q https://github.com/lh3/seqtk.git && cd seqtk && make -s && cd .. && mv seqtk/seqtk bin_external/ && rm -rf seqtk
    git clone -q https://github.com/DerrickWood/kraken2 && cd kraken2 && mkdir bin && ./install_kraken2.sh $PWD/bin &> /dev/null && cd .. && mv kraken2/bin/* bin_external/ && rm -rf kraken*
    git clone -q https://github.com/jenniferlu717/KrakenTools && cd KrakenTools && chmod +x * && cd .. && mv KrakenTools/* bin_external/ && rm -rf KrakenTools



  # R
    /usr/bin/Rscript -e 'install.packages("BiocManager",repos="https://cloud.r-project.org", quiet = T); 
                         BiocManager::install(c("GO.db", "biomaRt", "annotate", "impute", "preprocessCore", "AnnotationDbi"),update = FALSE, ask = FALSE,quiet=T); 
                         install.packages(c("minpack.lm","rgl","robustbase","textshape","openxlsx","dichromat","xtable","mime","bitops","bit64","pkgconfig","openssl","nloptr","dplyr","data.table","gtools","stringr","ggplot2","ggpubr","ggrepel","reshape","umap","funr","rentrez","curl","jpeg","png","rbioapi","GOxploreR","devtools","plotly","VennDiagram","colorspace","htmlwidgets","Hmisc","RColorBrewer","ggfortify","ggpmisc","ggdendro","cluster","factoextra","corrplot","WGCNA","tidyr","writexl","optparse","Rcpp"),repos="https://cloud.r-project.org", quiet = T); 
                         remotes::install_github("ctlab/fgsea",quiet=T); 
                         install.packages(c("https://cran.r-project.org/src/contrib/Archive/imguR/imguR_1.0.3.tar.gz","https://cran.r-project.org/src/contrib/Archive/qpcR/qpcR_1.4-1.tar.gz","https://cran.r-project.org/src/contrib/Archive/gsmoothr/gsmoothr_0.1.7.tar.gz"),repos = NULL, type = "source", quiet=T);
                         BiocManager::install(c("ComplexHeatmap","GSVA","GEOquery","scRecover","limma","affy","edgeR","DESeq2","NormqPCR","qpdf","sva","genefilter","M3C","clusterProfiler","Mfuzz","STRINGdb","enrichplot","pathview","DOSE","ReactomePA","org.Hs.eg.db","org.Mm.eg.db","GOfuncR","rrvgo","AnnotationHub","Repitools","GenomicFeatures","rtracklayer"),update = FALSE, ask = FALSE, quiet=T);
                         devtools::install_github(c("kkang7/CDSeq_R_Package","vqf/nVennR","wjawaid/enrichR","ievaKer/aPEAR"),upgrade="never",quiet=T);
                         install.packages("https://cran.r-project.org/src/contrib/Archive/autoGO/autoGO_0.9.1.tar.gz",repos = NULL, type = "source", quiet=T)' > /dev/null

          maptools y pak



  # Python
    pip install -q --break-system-packages --root-user-action ignore pysradb fastq-dl biopython openpyxl how_are_we_stranded_here statistics sphinx RSeQC multiqc brotlipy pysam scipy networkx pandas matplotlib python-igraph pyparsing git+https://github.com/netZoo/netZooPy.git ignore six markdown packaging markupsafe

    export PATH="$HOME/.pyenv/bin:$PATH" && pyenv install 3.11.1 && pyenv virtualenv 3.11.1 recentr && eval "$(pyenv init -)" && eval "$(pyenv virtualenv-init -)" && pyenv activate recentr && \
    pip install -q numpy==1.24.3 pandas==1.5.3 recentrifuge==1.16.1



  # Perl   
    cpanm --force -q Strict::Perl LWP Cwd less Class::MOP
    


  # Cleaning:
    apt-get remove -qy --auto-remove software-properties-common build-essential gcc g++ make cmake libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev libxml2-dev libcairo2-dev libncurses5-dev liblzma-dev libcurl4-openssl-dev libssl-dev libharfbuzz-dev libfribidi-dev r-base-dev python3-dev cython3 pkg-config dirmngr apt-utils wget > /dev/null && \
    apt-get -qy autoremove --purge > /dev/null && apt-get -q clean > /dev/null && \
    python3 -m pip cache purge > /dev/null && \
    rm -rf /var/lib/apt/lists/* /root/.cpanm /root/.cache /var/tmp/* /usr/share/doc/* /usr/share/man/* /usr/share/locale/* /usr/lib/*/include /usr/lib/*/*.a /usr/include/* /var/cache/apt/* /root/.wget-hsts /root/.cache/pip /var/cache/pip



%environment    
    export PATH="/root/edirect:/reanalyzerGSE:/reanalyzerGSE/scripts:/reanalyzerGSE/external_software/miARma-seq/:/bin_external:/root/.local/bin:/bin:/:/root/.pyenv/shims/:$PATH"



